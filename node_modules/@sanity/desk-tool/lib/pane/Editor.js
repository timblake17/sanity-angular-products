'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _debounce2 = require('lodash/debounce');

var _debounce3 = _interopRequireDefault(_debounce2);

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _class, _temp2;
// Connects the FormBuilder with various sanity roles


var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _spinner = require('part:@sanity/components/loading/spinner');

var _spinner2 = _interopRequireDefault(_spinner);

var _default = require('part:@sanity/components/buttons/default');

var _default2 = _interopRequireDefault(_default);

var _formBuilder = require('part:@sanity/form-builder');

var _formBuilder2 = _interopRequireDefault(_formBuilder);

var _ConfirmPublish = require('../components/ConfirmPublish');

var _ConfirmPublish2 = _interopRequireDefault(_ConfirmPublish);

var _ConfirmDiscard = require('../components/ConfirmDiscard');

var _ConfirmDiscard2 = _interopRequireDefault(_ConfirmDiscard);

var _ConfirmDelete = require('../components/ConfirmDelete');

var _ConfirmDelete2 = _interopRequireDefault(_ConfirmDelete);

var _ConfirmUnpublish = require('../components/ConfirmUnpublish');

var _ConfirmUnpublish2 = _interopRequireDefault(_ConfirmUnpublish);

var _InspectView = require('../components/InspectView');

var _InspectView2 = _interopRequireDefault(_InspectView);

var _router = require('part:@sanity/base/router');

var _trashIcon = require('part:@sanity/base/trash-icon');

var _trashIcon2 = _interopRequireDefault(_trashIcon);

var _undoIcon = require('part:@sanity/base/undo-icon');

var _undoIcon2 = _interopRequireDefault(_undoIcon);

var _publicIcon = require('part:@sanity/base/public-icon');

var _publicIcon2 = _interopRequireDefault(_publicIcon);

var _visibilityOffIcon = require('part:@sanity/base/visibility-off-icon');

var _visibilityOffIcon2 = _interopRequireDefault(_visibilityOffIcon);

var _binaryIcon = require('part:@sanity/base/binary-icon');

var _binaryIcon2 = _interopRequireDefault(_binaryIcon);

var _Editor = require('./styles/Editor.css');

var _Editor2 = _interopRequireDefault(_Editor);

var _copyDocument = require('../utils/copyDocument');

var _copyDocument2 = _interopRequireDefault(_copyDocument);

var _default3 = require('part:@sanity/components/menus/default');

var _default4 = _interopRequireDefault(_default3);

var _contentCopyIcon = require('part:@sanity/base/content-copy-icon');

var _contentCopyIcon2 = _interopRequireDefault(_contentCopyIcon);

var _document = require('part:@sanity/base/datastore/document');

var _document2 = _interopRequireDefault(_document);

var _schema = require('part:@sanity/base/schema');

var _schema2 = _interopRequireDefault(_schema);

var _draftUtils = require('../utils/draftUtils');

var _TimeAgo = require('../components/TimeAgo');

var _TimeAgo2 = _interopRequireDefault(_TimeAgo);

var _preview = require('part:@sanity/base/preview');

var _default5 = require('part:@sanity/components/panes/default');

var _default6 = _interopRequireDefault(_default5);

var _afterEditorComponent = require('all:part:@sanity/desk-tool/after-editor-component');

var _afterEditorComponent2 = _interopRequireDefault(_afterEditorComponent);

var _syncIcon = require('part:@sanity/base/sync-icon');

var _syncIcon2 = _interopRequireDefault(_syncIcon);

var _checkIcon = require('part:@sanity/base/check-icon');

var _checkIcon2 = _interopRequireDefault(_checkIcon);

var _default7 = require('part:@sanity/components/snackbar/default');

var _default8 = _interopRequireDefault(_default7);

var _resolveProductionUrl = require('part:@sanity/transitional/production-preview/resolve-production-url?');

var _resolveProductionUrl2 = _interopRequireDefault(_resolveProductionUrl);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const preventDefault = ev => ev.preventDefault();

// Want a nicer api for listen/unlisten
function listen(target, eventType, callback, useCapture = false) {
  target.addEventListener(eventType, callback, useCapture);
  return function unlisten() {
    target.removeEventListener(eventType, callback, useCapture);
  };
}

const getDuplicateItem = (draft, published) => ({
  action: 'duplicate',
  title: 'Duplicate',
  icon: _contentCopyIcon2.default,
  divider: true,
  isDisabled: !draft && !published
});

const getDiscardItem = (draft, published) => ({
  action: 'discard',
  title: 'Discard changes…',
  icon: _undoIcon2.default,
  divider: true,
  isDisabled: !draft || !published
});

const getUnpublishItem = (draft, published) => ({
  action: 'unpublish',
  title: 'Unpublish…',
  icon: _visibilityOffIcon2.default,
  divider: true,
  isDisabled: !published
});

const getDeleteItem = (draft, published) => ({
  action: 'delete',
  title: 'Delete…',
  icon: _trashIcon2.default,
  divider: true,
  danger: true,
  isDisabled: !draft && !published
});

const getInspectItem = (draft, published) => ({
  action: 'inspect',
  title: _react2.default.createElement(
    'span',
    null,
    'Inspect ',
    _react2.default.createElement(
      'code',
      { className: _Editor2.default.hotkey },
      'Ctrl+Alt+I'
    )
  ),
  icon: _binaryIcon2.default,
  divider: true,
  isDisabled: !(draft || published)
});

const getProductionPreviewItem = (draft, published) => {
  const snapshot = draft || published;
  if (!snapshot || !_resolveProductionUrl2.default) {
    return null;
  }
  let previewUrl;
  try {
    previewUrl = (0, _resolveProductionUrl2.default)(snapshot);
  } catch (error) {
    error.message = `An error was thrown while trying to get production preview url: ${error.message}`;
    // eslint-disable-next-line no-console
    console.error(error);
    return null;
  }

  return previewUrl && {
    action: 'production-preview',
    title: _react2.default.createElement(
      'span',
      null,
      'Open preview ',
      _react2.default.createElement(
        'code',
        { className: _Editor2.default.hotkey },
        'Ctrl+Alt+O'
      )
    ),
    icon: _publicIcon2.default,
    url: previewUrl
  };
};

const getMenuItems = (draft, published) => [getProductionPreviewItem, getDiscardItem, getUnpublishItem, getDuplicateItem, getDeleteItem, getInspectItem].map(fn => fn(draft, published)).filter(Boolean);

const INITIAL_STATE = {
  inspect: false,
  isMenuOpen: false,
  isCreatingDraft: false,
  showSavingStatus: false,
  showConfirmPublish: false,
  showConfirmDiscard: false,
  showConfirmDelete: false,
  showConfirmUnpublish: false
};

function getToggleKeyState(event) {
  if (event.ctrlKey && event.code === 'KeyI' && event.altKey && !event.shiftKey) {
    return 'inspect';
  }

  if (event.ctrlKey && event.code === 'KeyP' && event.altKey && !event.shiftKey) {
    return 'showConfirmPublish';
  }

  return undefined;
}
function navigateUrl(url) {
  window.open(url);
}

exports.default = (0, _router.withRouterHOC)((_temp2 = _class = class Editor extends _react2.default.PureComponent {
  constructor(...args) {
    var _temp;

    return _temp = super(...args), this.state = INITIAL_STATE, this.setSavingStatus = (0, _debounce3.default)(() => {
      this.setState({
        showSavingStatus: false
      });
    }, 1500, { trailing: true }), this.handleCreateCopy = () => {
      var _props = this.props;
      const router = _props.router,
            draft = _props.draft,
            published = _props.published;

      _document2.default.create((0, _draftUtils.newDraftFrom)((0, _copyDocument2.default)(draft || published))).subscribe(copied => {
        router.navigate(_extends({}, router.state, { action: 'edit', selectedDocumentId: (0, _draftUtils.getPublishedId)(copied._id) }));
      });
    }, this.handleEditAsActualType = () => {
      var _props2 = this.props;
      const router = _props2.router,
            draft = _props2.draft,
            published = _props2.published;

      const actualTypeName = draft._type || published._type;
      router.navigate(_extends({}, router.state, {
        selectedType: actualTypeName,
        action: 'edit'
      }));
    }, this.handleChange = changeEvent => {
      const onChange = this.props.onChange;

      onChange(changeEvent);
    }, this.handleRestore = () => {
      const deletedSnapshot = this.props.deletedSnapshot;

      this.props.onCreate(deletedSnapshot);
    }, this.handleMenuToggle = () => {
      this.setState({
        isMenuOpen: !this.state.isMenuOpen
      });
    }, this.handleMenuClose = () => {
      this.setState({
        isMenuOpen: false
      });
    }, this.handlePublishButtonClick = () => {
      this.setState({ showConfirmPublish: true });
    }, this.handleCancelConfirmPublish = () => {
      this.setState({ showConfirmPublish: false });
    }, this.handleCancelUnpublish = () => {
      this.setState({ showConfirmUnpublish: false });
    }, this.handleCancelDelete = () => {
      this.setState({ showConfirmDelete: false });
    }, this.handleCancelDiscard = () => {
      this.setState({ showConfirmDiscard: false });
    }, this.handleConfirmPublish = () => {
      var _props3 = this.props;
      const onPublish = _props3.onPublish,
            draft = _props3.draft;

      onPublish(draft);
      this.setState({ showConfirmPublish: false });
    }, this.handleConfirmUnpublish = () => {
      const onUnpublish = this.props.onUnpublish;

      onUnpublish();
      this.setState({ showConfirmUnpublish: false });
    }, this.handleConfirmDiscard = () => {
      var _props4 = this.props;
      const onDiscardDraft = _props4.onDiscardDraft,
            draft = _props4.draft;

      onDiscardDraft(draft);
      this.setState({ showConfirmDiscard: false });
    }, this.handleConfirmDelete = () => {
      var _props5 = this.props;
      const onDelete = _props5.onDelete,
            onDiscardDraft = _props5.onDiscardDraft,
            published = _props5.published;

      if (published) {
        onDelete();
      } else {
        onDiscardDraft();
      }
      this.setState({ showConfirmDelete: false });
    }, this.handleMenuClick = item => {
      if (item.action === 'delete') {
        this.setState({ showConfirmDelete: true });
      }
      if (item.action === 'discard') {
        this.setState({ showConfirmDiscard: true });
      }

      if (item.action === 'unpublish') {
        this.setState({ showConfirmUnpublish: true });
      }

      if (item.action === 'publish') {
        this.setState({ showConfirmPublish: true });
      }

      if (item.action === 'duplicate') {
        this.handleCreateCopy();
      }

      if (item.action === 'inspect') {
        this.setState({ inspect: true });
      }

      if (item.action === 'production-preview') {
        navigateUrl(item.url);
      }

      this.setState({ isMenuOpen: false });
    }, this.renderFunctions = () => {
      var _props6 = this.props;
      const draft = _props6.draft,
            published = _props6.published;
      const showSavingStatus = this.state.showSavingStatus;


      const value = draft || published;

      return _react2.default.createElement(
        'div',
        { className: _Editor2.default.paneFunctions },
        showSavingStatus && _react2.default.createElement(
          'div',
          { className: _Editor2.default.syncStatusSyncing },
          _react2.default.createElement(
            'span',
            { className: _Editor2.default.spinnerContainer },
            _react2.default.createElement(
              'span',
              { className: _Editor2.default.spinner },
              _react2.default.createElement(_syncIcon2.default, null)
            )
          ),
          ' Syncing\u2026'
        ),
        value && !showSavingStatus && _react2.default.createElement(
          'div',
          { className: _Editor2.default.syncStatusSynced },
          _react2.default.createElement(_checkIcon2.default, null),
          ' Synced'
        ),
        _react2.default.createElement(
          'div',
          { className: _Editor2.default.publishButton },
          _react2.default.createElement(
            _default2.default,
            {
              title: 'Ctrl+Alt+P',
              disabled: !draft,
              onClick: this.handlePublishButtonClick,
              color: 'primary'
            },
            published ? 'Publish changes' : 'Publish'
          )
        )
      );
    }, this.renderMenu = () => {
      var _props7 = this.props;
      const draft = _props7.draft,
            published = _props7.published;

      return _react2.default.createElement(_default4.default, {
        onAction: this.handleMenuClick,
        isOpen: this.state.isMenuOpen,
        onClose: this.handleMenuClose,
        onClickOutside: this.handleMenuClose,
        items: getMenuItems(draft, published),
        origin: 'top-right'
      });
    }, _temp;
  }

  componentDidMount() {
    this.unlistenForKey = listen(window, 'keyup', event => {
      const toggleKey = getToggleKeyState(event);
      if (event.ctrlKey && event.code === 'KeyO' && event.altKey && !event.shiftKey) {
        var _props8 = this.props;
        const draft = _props8.draft,
              published = _props8.published;

        const item = getProductionPreviewItem(draft || published);
        if (item && item.url) {
          navigateUrl(item.url);
        }
      } else if (toggleKey) {
        this.setState(prevState => ({ [toggleKey]: !prevState[toggleKey] }));
      }
    });
  }

  componentWillUnmount() {
    this.unlistenForKey();
    this.setSavingStatus.cancel();
  }

  componentWillReceiveProps(nextProps) {
    if (this.props.isSaving && !nextProps.isSaving) {
      this.setState({
        showSavingStatus: true
      });
      this.setSavingStatus();
    }
  }

  getTitle(value) {
    const type = this.props.type;

    if (!value) {
      return `Creating new ${type.title || type.name}`;
    }
    return _react2.default.createElement(
      _preview.PreviewFields,
      { document: value, type: type, fields: ['title'] },
      ({ title }) => _react2.default.createElement(
        'span',
        null,
        title
      )
    );
  }

  render() {
    var _props9 = this.props;
    const draft = _props9.draft,
          published = _props9.published,
          type = _props9.type,
          isLoading = _props9.isLoading,
          isPublishing = _props9.isPublishing,
          isUnpublishing = _props9.isUnpublishing,
          isCreatingDraft = _props9.isCreatingDraft,
          patchChannel = _props9.patchChannel,
          transactionResult = _props9.transactionResult,
          onClearTransactionResult = _props9.onClearTransactionResult;
    var _state = this.state;
    const inspect = _state.inspect,
          showConfirmPublish = _state.showConfirmPublish,
          showConfirmDelete = _state.showConfirmDelete,
          showConfirmDiscard = _state.showConfirmDiscard,
          showConfirmUnpublish = _state.showConfirmUnpublish;


    const value = draft || published;

    if (isLoading) {
      return _react2.default.createElement(
        'div',
        { className: _Editor2.default.root },
        _react2.default.createElement(_spinner2.default, { center: true, message: `Loading ${type.title}…` })
      );
    }

    const hasTypeMismatch = value && value._type && value._type !== type.name;
    if (hasTypeMismatch) {
      return _react2.default.createElement(
        'div',
        { className: _Editor2.default.typeMisMatchMessage },
        'This document is of type ',
        _react2.default.createElement(
          'code',
          null,
          value._type
        ),
        ' and cannot be edited as ',
        _react2.default.createElement(
          'code',
          null,
          type.name
        ),
        _react2.default.createElement(
          'div',
          null,
          _react2.default.createElement(
            _default2.default,
            { onClick: this.handleEditAsActualType },
            'Edit as ',
            value._type,
            ' instead'
          )
        )
      );
    }

    return _react2.default.createElement(
      _default6.default,
      {
        title: this.getTitle(value),
        renderMenu: this.renderMenu,
        renderFunctions: this.renderFunctions,
        onMenuToggle: this.handleMenuToggle
      },
      _react2.default.createElement(
        'div',
        { className: _Editor2.default.root },
        isCreatingDraft && _react2.default.createElement(_spinner2.default, { fullscreen: true, message: 'Making changes\u2026' }),
        isPublishing && _react2.default.createElement(_spinner2.default, { fullscreen: true, message: 'Publishing\u2026' }),
        isUnpublishing && _react2.default.createElement(_spinner2.default, { fullscreen: true, message: 'Unpublishing\u2026' }),
        _react2.default.createElement(
          'div',
          { className: _Editor2.default.top },
          _react2.default.createElement(
            'div',
            { className: _Editor2.default.editedDate },
            value && _react2.default.createElement(
              'span',
              null,
              'Edited ',
              _react2.default.createElement(_TimeAgo2.default, { time: value._updatedAt })
            )
          ),
          _react2.default.createElement(
            'div',
            { className: _Editor2.default.publishedDate },
            published ? _react2.default.createElement(
              'span',
              null,
              'Published ',
              _react2.default.createElement(_TimeAgo2.default, { time: published._updatedAt })
            ) : 'Not published'
          )
        ),
        _react2.default.createElement(
          'form',
          { className: _Editor2.default.editor, onSubmit: preventDefault, id: 'Sanity_Default_DeskTool_Editor_ScrollContainer' },
          _react2.default.createElement(_formBuilder2.default, {
            schema: _schema2.default,
            patchChannel: patchChannel,
            value: draft || published || { _type: type.name },
            type: type,
            onChange: this.handleChange
          })
        ),
        _afterEditorComponent2.default.map((AfterEditorComponent, i) => _react2.default.createElement(AfterEditorComponent, { key: i, documentId: published._id })),
        inspect && _react2.default.createElement(_InspectView2.default, {
          value: value,
          onClose: () => this.setState({ inspect: false })
        }),
        showConfirmPublish && _react2.default.createElement(_ConfirmPublish2.default, {
          draft: draft,
          published: published,
          onCancel: this.handleCancelConfirmPublish,
          onConfirm: this.handleConfirmPublish
        }),
        showConfirmDiscard && _react2.default.createElement(_ConfirmDiscard2.default, {
          draft: draft,
          published: published,
          onCancel: this.handleCancelDiscard,
          onConfirm: this.handleConfirmDiscard
        }),
        showConfirmDelete && _react2.default.createElement(_ConfirmDelete2.default, {
          draft: draft,
          published: published,
          onCancel: this.handleCancelDelete,
          onConfirm: this.handleConfirmDelete
        }),
        showConfirmUnpublish && _react2.default.createElement(_ConfirmUnpublish2.default, {
          draft: draft,
          published: published,
          onCancel: this.handleCancelUnpublish,
          onConfirm: this.handleConfirmUnpublish
        }),
        transactionResult && transactionResult.type === 'error' && _react2.default.createElement(
          _default8.default,
          {
            kind: 'danger',
            action: { title: 'Ok, got it' },
            onAction: onClearTransactionResult
          },
          _react2.default.createElement(
            'div',
            null,
            transactionResult.message,
            _react2.default.createElement(
              'details',
              null,
              transactionResult.error.message
            )
          )
        )
      )
    );
  }
}, _class.propTypes = {
  patchChannel: _propTypes2.default.object,
  draft: _propTypes2.default.object,
  published: _propTypes2.default.object,
  type: _propTypes2.default.object.isRequired,
  router: _propTypes2.default.shape({
    state: _propTypes2.default.object
  }).isRequired,

  onDelete: _propTypes2.default.func,
  onCreate: _propTypes2.default.func,
  onChange: _propTypes2.default.func,
  onDiscardDraft: _propTypes2.default.func,
  onPublish: _propTypes2.default.func,
  onUnpublish: _propTypes2.default.func,
  transactionResult: _propTypes2.default.func,
  onClearTransactionResult: _propTypes2.default.func,

  isCreatingDraft: _propTypes2.default.bool,
  isUnpublishing: _propTypes2.default.bool,
  isPublishing: _propTypes2.default.bool,
  isLoading: _propTypes2.default.bool,
  isSaving: _propTypes2.default.bool,
  deletedSnapshot: _propTypes2.default.object
}, _class.defaultProps = {
  isLoading: false,
  isSaving: false,
  isUnpublishing: false,
  isPublishing: false,
  isCreatingDraft: false,
  deletedSnapshot: null,
  transactionResult: null,
  onDelete() {},
  onCreate() {},
  onChange() {},
  onClearTransactionResult() {}
}, _temp2));